<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="/common/header::header(~{::title},~{},~{})">
  <title>预算评审系统-添加方案</title>
</head>
<body>
<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-body" style="padding-top: 10px;">
      <div class="layui-carousel" id="stepForm" lay-filter="stepForm" style="margin: 0 auto;">
        <div carousel-item style="overflow: visible;">
          <div>
            <form class="layui-form" method="post" id="xm_Form_basic">
              <div class="layui-form-item">
                <table class="layui-table" lay-size="xm">
                  <tr>
                    <th style="white-space: nowrap;">项目编号</th>
                    <td>
                      <input type="text" readonly id="xmbh" name="xmbh" class="layui-input"/>
                    </td>
                    <th style="white-space: nowrap;">项目名称</th>
                    <td>
                      <input type="text" name="xmmc" class="layui-input"/>
                    </td>
                    <th style="white-space: nowrap;">项目分类</th>
                    <td>
                      <!--<input type="text" name="xmfl_zd"  class="layui-input"/>-->
                      <select name="xmfl_zd" id="xmfl_zd">
                        <option value="" selected>请选择项目分类</option>
                        <option th:each="zd,stat:${dict_xmfl}" th:value="${zd.zdz}"
                                th:text="${zd.zdm}"></option>
                      </select>
                    </td>
                    <th style="white-space: nowrap;">项目性质</th>
                    <td>
                      <!--<input type="text" name="xmxz_zd"  class="layui-input"/>-->
                      <select name="xmxz_zd" id="xmxz_zd">
                        <option value="" selected>请选择项目性质</option>
                        <option th:each="zd,stat:${dict_xmxz}" th:value="${zd.zdz}"
                                th:text="${zd.zdm}"></option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <th style="white-space: nowrap;">委托时间</th>
                    <td>
                      <input type="text" readonly name="wtsj" class="layui-input"/>
                    </td>
                    <th style="white-space: nowrap;">委托金额</th>
                    <td>
                      <input type="number" name="wtje" class="layui-input"/>
                    </td>
                    <th style="white-space: nowrap;">联系人</th>
                    <td>
                      <input type="text" name="lxr" class="layui-input"/>
                    </td>
                    <th style="white-space: nowrap;">联系电话</th>
                    <td>
                      <input type="text" name="lxr" class="layui-input"/>
                    </td>
                  </tr>
                  <tr>
                    <th style="white-space: nowrap;">项目实施单位</th>
                    <td colspan="2">
                      <input type="text" name="xmssdw" class="layui-input"/>
                    </td>
                    <th style="white-space: nowrap;">建设内容</th>
                    <td colspan="4">
                      <textarea name="jsbr" class="layui-textarea"></textarea>
                    </td>
                  </tr>
                  <tr>
                    <th style="white-space: nowrap;">评审目标及要求</th>
                    <td colspan="7">
                      <textarea name="psmbjyq" class="layui-textarea"></textarea>
                    </td>
                  </tr>
                  <tr>
                    <th style="white-space: nowrap;">评审结果使用方向</th>
                    <td colspan="7">
                      <textarea name="psmbjyq" class="layui-textarea"></textarea>
                    </td>
                  </tr>
                </table>
              </div>
              <div class="layui-form-item">
                <div class="">
                  <button class="layui-btn" lay-submit lay-filter="xm_Form_basic">
                    &emsp;下一步&emsp;
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div>
            <form class="layui-form" method="post" id="xm_Form_fj">

              <fieldset class="layui-elem-field layui-field-title">
                <legend>资金来源(多个)</legend>
              </fieldset>

              <div class="layui-upload">
                <button type="button" class="layui-btn layui-btn-normal" id="file_zjly">选择资金来源</button>
                <div class="layui-upload-list">
                  <table class="layui-table">
                    <thead>
                    <tr>
                      <th>文件名</th>
                      <th>大小</th>
                      <th>上传进度</th>
                      <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="fileList_zjly"></tbody>
                  </table>
                </div>
                <button type="button" class="layui-btn" id="upload_zjly">开始上传</button>
              </div>

              <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                <legend>立项文件(多个)</legend>
              </fieldset>

              <div class="layui-upload">
                <button type="button" class="layui-btn layui-btn-normal" id="file_lxwj">选择立项文件</button>
                <div class="layui-upload-list">
                  <table class="layui-table">
                    <thead>
                    <tr>
                      <th>文件名</th>
                      <th>大小</th>
                      <th>上传进度</th>
                      <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="fileList_lxwj"></tbody>
                  </table>
                </div>
                <button type="button" class="layui-btn" id="upload_lxwj">开始上传</button>
              </div>

              <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                <legend>政府审批意见（会员纪要）(多个)</legend>
              </fieldset>

              <div class="layui-upload">
                <button type="button" class="layui-btn layui-btn-normal" id="file_spyj">政府审批意见（会员纪要）</button>
                <div class="layui-upload-list">
                  <table class="layui-table">
                    <thead>
                    <tr>
                      <th>文件名</th>
                      <th>大小</th>
                      <th>上传进度</th>
                      <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="fileList_spyj"></tbody>
                  </table>
                </div>
                <button type="button" class="layui-btn" id="upload_spyj">开始上传</button>
              </div>

              <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                <legend>其他(多个)</legend>
              </fieldset>

              <div class="layui-upload">
                <button type="button" class="layui-btn layui-btn-normal" id="file_qt">其他</button>
                <div class="layui-upload-list">
                  <table class="layui-table">
                    <thead>
                    <tr>
                      <th>文件名</th>
                      <th>大小</th>
                      <th>上传进度</th>
                      <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="fileList_qt"></tbody>
                  </table>
                </div>
                <button type="button" class="layui-btn" id="upload_qt">开始上传</button>
              </div>

              <hr/>

              <div class="layui-form-item">
                <div class="">
                  <button type="button" class="layui-btn layui-btn-primary pre">上一步</button>
                  <button class="layui-btn" lay-submit lay-filter="xm_Form_fj">
                    &emsp;保存&emsp;
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div>
            <div style="text-align: center;margin-top: 90px;">
              <i class="layui-icon layui-circle"
                 style="color: white;font-size:30px;font-weight:bold;background: #52C41A;padding: 20px;line-height: 80px;">&#xe605;</i>
              <div style="font-size: 24px;color: #333;font-weight: 500;margin-top: 30px;">
                保存成功
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div th:replace="/common/footer::footer()"></div>

<script type="text/javascript" th:src="@{/static/js/xm/xmfj.js}"></script>

<script th:inline="javascript">
  const cuser = [[${cuser}]];

  layui.config({
    base: ctx + 'static/js/layuiExts/'
  }).extend({
    step: 'step/step-lay/step'
  }).use(['element', 'laydate', 'table', 'form', 'step', 'upload'], function () {
    let element = layui.element;
    let laydate = layui.laydate;
    let form = layui.form;
    let table = layui.table;
    let step = layui.step;
    let upload = layui.upload;

    laydate.render({
      elem: "input[name='wtsj']"
    });

    //分布
    step.render({
      elem: '#stepForm',
      filter: 'stepForm',
      width: '100%', //设置容器宽度
      stepWidth: '750px',
      height: '500px',
      stepItems: [{
        title: '填写基础信息'
      }, {
        title: '上传附件'
      }, {
        title: '完成'
      }]
    });

    form.on('submit(xm_Form_basic)', function (data) {
      step.next('#stepForm');
      return false;
    });

    form.on('submit(formStep2)', function (data) {
      step.next('#stepForm');
      return false;
    });

    //上一步
    $('.pre').click(function () {
      step.pre('#stepForm');
    });
    //下一步
    $('.next').click(function () {
      step.next('#stepForm');
    });

    //文件上传
    renderUpload('#file_zjly', '#fileList_zjly', '#upload_zjly', '资金来源');

    //项目编号
    getXmbh();

    //项目
    let xm = {
      model: {},
      list: []
    };

    //获取项目编号
    function getXmbh() {
      let loadi = top.layer.load();
      $.ajax({
        url: ctx + "CZF/XMGL/getXmbh",
        async: false,
        success: function (data) {
          top.layer.close(loadi); //关闭弹出框
          let xmbh = data.data;
          $("#xmbh").val(xmbh);
          return false;
        },
        error: function (XMLHttpRequest, textStatus, errorThrown) {
          top.layer.close(loadi); //关闭弹出框
          top.layer.msg(XMLHttpRequest.responseJSON.msg ? XMLHttpRequest.responseJSON.msg : "获取项目编号失败!");
          return false;
        }
      });
    }

    /**
     * 渲染文件上传
     * @param elem 文本域id #xxx
     * @param elemList 文件列表id #xxx
     * @param bindAction 上传按钮 #xxx
     * @param type 附件类型
     */
    function renderUpload(elem, elemList, bindAction, type) {
      let uploadIns = upload.render({
        elem: elem,
        elemList: $(elemList),
        url: ctx + "CZF/XMGL/upload",
        accept: 'file',
        multiple: false,
        data: {type: type},
        number: 3,
        auto: false,
        field: 'file',
        bindAction: bindAction,
        exts: 'jpg|png|gif|bmp|jpeg|pdf',
        choose: function (obj) {
          let that = this;
          let files = that.files = obj.pushFile();
          //读取本地文件
          obj.preview(function (index, file, result) {
            let tr = $(['<tr id="upload-' + index + '">',
              '<td>' + file.name + '</td>',
              '<td>' + (file.size / 1014).toFixed(1) + 'kb</td>',
              '<td><div class="layui-progress" lay-filter="progress-demo-' + index + '"><div class="layui-progress-bar" lay-percent=""></div></div></td>',
              '<td>',
              '<button class="layui-btn layui-btn-xs layui-btn-danger init-delete">删除</button>',
              '</td>',
              '</tr>'].join(''));

            //单个重传
            tr.find('.demo-reload').on('click', function () {
              obj.upload(index, file);
            });

            //删除
            tr.find('.init-delete').on('click', function () {
              delete files[index]; //删除对应的文件
              tr.remove();
              uploadIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
            });

            that.elemList.append(tr);
            element.render('progress'); //渲染新加的进度条组件
          });
        },
        done: function (res, index, upload) { //成功的回调
          debugger;
          let that = this;
          let xmfj = res.data;

          let tr = that.elemList.find('tr#upload-' + index), tds = tr.children();

          tds.eq(3).html("" +
            "<button data-fjmc='" + xmfj.fjmc + "' data-fjdz='" + xmfj.fjdz + "' class='layui-btn layui-btn-xs fj-download'>下载</button>" +
            "<button data-fjmc='" + xmfj.fjmc + "' data-fjdz='" + xmfj.fjdz + "' class='layui-btn layui-btn-xs layui-btn-danger fj-delete'>删除</button>"
          ); //清空操作
          delete that.files[index]; //删除文件队列已经上传成功的文件

          //添加附件信息
          xm.list.push(xmfj);

          //删除附件方法
          tr.find('.fj-delete').on('click', function () {
            //调用接口删除已上传的文件
            let path = $(this).attr("data-fjdz");
            XMFJ.delXmFj(path, function () {
              delete that.files[index]; //删除对应的文件
              tr.remove();
              uploadIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
              return false;
            });
            return false;
          });

          //下载附件方法
          tr.find('.fj-download').on('click', function () {
            let path = $(this).attr("data-fjdz");
            let name = $(this).attr("data-fjmc");
            let dUrl = ctx + "common/download/upload?resource=" + path + "&name=" + name;
            window.open(dUrl);
            return false;
          });
          return false;
        },
        allDone: function (obj) { //多文件上传完毕后的状态回调
          console.log(obj);
          return false;
        },
        error: function (index, upload) { //错误回调
          let that = this;
          let tr = that.elemList.find('tr#upload-' + index)
            , tds = tr.children();
          tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
        },
        progress: function (n, elem, e, index) { //注意：index 参数为 layui 2.6.6 新增
          element.progress('progress-demo-' + index, n + '%'); //执行进度条。n 即为返回的进度百分比
        }
      });
    }
  });
</script>
</body>
</html>